---
description: AgentPacket runloop contract (Builder + Verifier + Supervisor)
globs:
  - "**/*"
---

# AgentPacket v1.0 (Runloop Contract)

## Purpose
Turn PR work into a deterministic loop.
Minimize human intervention.
Humans only step in at explicit Breakpoints.

## Definitions
- **AgentPacket**: The set of files that define and govern a PR.
  - INPUT (what to build)
  - CHECKLIST (merge bar, with evidence)
  - FIXLOG (append-only change + failure log)
  - Optional: AGENTPACK (index pointing to the above paths)
- **Builder**: Implements until all AUTO items are satisfied and all gates are green.
- **Verifier**: Independently reruns gates and checklist validation. Produces a Verifier Report.
- **Supervisor**: Runs Builder then Verifier. If Verifier fails, loops back to Builder.

## Non-negotiables
- Do not invent actions. If you did not run a command, do not claim you did.
- Treat INPUT as execution truth. Do not expand scope.
- Keep CHECKLIST and FIXLOG updated. These are required outputs of the run.

## Packet discovery (preferred: docs/pr snapshots)
Use this order:

1) If an `AGENTPACK.md` exists under `docs/pr/PR-*/*`, use the newest one (highest PR number, then newest mtime).
2) Else if an `AGENTPACK.md` exists under `pr/PR-*/*`, use the newest one.
3) Else look for sibling files:
   - `docs/pr/PR-*/INPUT.md`, `CHECKLIST.md`, `FIXLOG.md`
   - `pr/PR-*/INPUT.md`, `CHECKLIST.md`, `FIXLOG.md`
4) Else fall back to pattern match anywhere:
   - `INPUT-PR-*.md`
   - `CHECKLIST-PR-*.md`
   - `FIXLOG-PR-*.md`

If you cannot confidently resolve a single packet, stop and ask for the exact packet folder path.

## Checklist semantics (AUTO vs DEVICE)
Goal: complete all AUTO items without human involvement.
DEVICE items are allowed to remain pending until human QA.

Classification rules:
- If a checklist line contains `(device QA required)` (any casing), classify as **DEVICE**.
- If a checklist line starts with `[DEVICE]`, classify as DEVICE.
- Otherwise classify as **AUTO**.

Behavior:
- For AUTO items:
  - Do the work, run the evidence command(s), then check the box and record evidence.
- For DEVICE items:
  - Do everything possible in simulator/tests/logs.
  - Do NOT mark as complete.
  - Mark as `PENDING DEVICE` in-line (minimal edit) or add a short note under a `## Device QA Pending` section at the bottom.

## Medium UI Gate (required when UI is touched)
Trigger the UI gate if any of these are true:
- The packet is a UI-focused PR (title includes "UI" or checklist includes UI sections), or
- SwiftUI/UI files changed (Swift: `Views/`, `SwiftUI`, `*.swift` touching view/layout), or
- CHECKLIST includes haptics/gestures/visual polish requirements.

Medium UI Gate requirements:
1) Add **SwiftUI snapshot tests** for 3 to 5 "regression magnets" relevant to the PR.
2) Add **accessibility identifiers** for critical interactive elements used in tests.
3) Run snapshot tests in CI-compatible way.
4) Record snapshot outputs and how to update them (if you use record mode) in CHECKLIST evidence.

Snapshot scope rule:
- Keep it small. 3 to 5 snapshots only.
- Prefer state-driven views, not whole app end-to-end.

## Gate execution (generic)
You must run the repoâ€™s canonical gates:
- unit
- lint
- integration
- snapshot tests (if Medium UI Gate triggered)

Discovery:
- Prefer repo scripts (package.json scripts, Makefile targets, existing `./scripts/*`).
- If multiple options exist, choose the most standard and repeatable.

Evidence rules:
- CHECKLIST must include:
  - commands run
  - pass/fail results
  - where logs/artifacts live
- FIXLOG must include:
  - what failed
  - why (root cause hypothesis)
  - what changed
  - what remains

## Builder loop (default)
Repeat until all AUTO items are complete and all gates are green:

1) Read INPUT, CHECKLIST, FIXLOG fully.
2) Implement smallest viable slice aligned to INPUT.
3) Run gates.
4) Update CHECKLIST evidence and FIXLOG entries.
5) If gates fail, fix and rerun.

Attempt cap:
- Up to 3 repair attempts per distinct failure class.
- If still failing, stop at Breakpoint and produce a "Help Needed" block.

## Verifier loop (independent)

- Rerun gates from a clean state.
- Validate checklist claims against actual runs.
- Produce a Verifier Report:
  - Pass/Fail
  - Commands run
  - What is still pending (especially DEVICE)
  - Risk notes
- Append the Verifier Report to FIXLOG under `## Verifier Report` (create if missing).

## Supervisor loop (run-pr)

- Run Builder.
- Run Verifier.
- If Verifier fails:
  - loop back to Builder with verifier findings as constraints
  - repeat up to 2 full cycles
- If still failing after 2 cycles, stop at Breakpoint with a concise "Help Needed" block.

## Promote to Canon reminder

If the PR is ready to merge, call out any `## Promote to Canon` items still marked TBD.

## Breakpoints (stop conditions)
Stop only when one of these is true:

- **DEVICE REQUIRED**: a required checklist item is DEVICE and cannot be validated without human.
- **SIGNING/PROFILES**: requires provisioning, certs, keychain access, or device-only steps.
- **SNAPSHOT INSTABILITY**: snapshots are nondeterministic and cannot be stabilized with reasonable fixes.
- **UNKNOWN FAILURE**: repeated failures exceed attempt cap, root cause unclear.
- **CROSS-REPO DEPENDENCY**: you need changes in another repo to proceed.

Breakpoint output format (write to FIXLOG):
- What you tried (commands)
- What failed (error snippet)
- Current hypothesis (FACT vs ASSUMPTION)
- Next smallest suggested actions

## Minimal edit discipline
- Do not reformat whole documents.
- Change only the lines you must.
- Append to FIXLOG, do not rewrite history.

## Git hygiene
- Keep commits scoped.
- Commit messages should mention PR and area (UI, Haptics, Drafts).
- Never commit secrets.
