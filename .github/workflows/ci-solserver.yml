name: SolServer CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: solserver-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Guard lockfiles
        run: |
          if [ -f package-lock.json ]; then
            echo "package-lock.json is not allowed; pnpm is canonical."
            exit 1
          fi
          if [ ! -f pnpm-lock.yaml ]; then
            echo "pnpm-lock.yaml is required for CI."
            exit 1
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        env:
          CI: true
          LLM_PROVIDER: ${{ vars.LLM_PROVIDER || 'fake' }}
          EVIDENCE_PROVIDER: ${{ vars.EVIDENCE_PROVIDER || 'stub' }}
          EVIDENCE_PROVIDER_FORCE: ${{ vars.EVIDENCE_PROVIDER_FORCE || '0' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || 'https://api.openai.com/v1' }}
          RUN_OPENAI_INTEGRATION: ${{ vars.RUN_OPENAI_INTEGRATION || '0' }}
          CONTROL_PLANE_DB_PATH: ${{ vars.CONTROL_PLANE_DB_PATH || './data/control_plane.db' }}
          LOG_LEVEL: ${{ vars.LOG_LEVEL || 'info' }}
          PINO_PRETTY: ${{ vars.PINO_PRETTY || '0' }}
          TRACE_CAPTURE_MODEL_IO: ${{ vars.TRACE_CAPTURE_MODEL_IO || '0' }}
          SOL_ENV: ${{ vars.SOL_ENV || 'local' }}
          SOL_MODEL_DEFAULT: ${{ vars.SOL_MODEL_DEFAULT }}
          SOL_MODEL_LOCAL: ${{ vars.SOL_MODEL_LOCAL }}
          SOL_MODEL_FLY_DEV: ${{ vars.SOL_MODEL_FLY_DEV }}
          SOL_MODEL_FLY_STAGING: ${{ vars.SOL_MODEL_FLY_STAGING }}
          SOL_MODEL_PROD: ${{ vars.SOL_MODEL_PROD }}
          SOL_ALLOW_MODEL_OVERRIDE: ${{ vars.SOL_ALLOW_MODEL_OVERRIDE || '0' }}
        run: pnpm test
